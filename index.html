<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Smart Stethoscope Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      text-align: center;
      padding: 15px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header { font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 12px; }
    #status { padding: 8px 14px; border-radius: 8px; background: #e2e8f0; color: #0f172a; display: inline-block; margin-bottom: 10px; }
    
    canvas {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      width: 100%;
      max-width: 800px; 
      height: 30vh; 
      min-height: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    .controls { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    #startBtn { background: #3b82f6; color: #fff; }
    #stopBtn { background: #f1f5f9; color: #1e293b; }
    #reportBtn { background: #10b981; color: #fff; }
    #bpm { font-size: 40px; font-weight: 800; margin-top: 10px; color: #ef4444; }
  </style>
</head>
<body>
  <header>Smart Stethoscope Dashboard</header>
  <div id="status">Disconnected</div>
  <canvas id="wave"></canvas>
  <div id="bpm">-- BPM</div>
  <div class="controls">
    <button id="startBtn">‚ñ∂ Start Monitoring</button>
    <button id="stopBtn" disabled>‚è∏ Stop</button>
    <button id="reportBtn" style="display:none;">üìÑ Download Report</button>
  </div>

  <script>
    const WSS_URL = 'wss://669c1d46b8674baa9e5592f13461ccb7.s1.eu.hivemq.cloud:8884/mqtt';
    const MQTT_USER = 'stethoscope';
    const MQTT_PASS = 'Steth123';
    const TOPIC = 'stethoscope/device1/events';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let client=null, connected=false, paused=false;
    
    // bpmHistory will now hold objects: { time: string, bpm: number }
    let bpmHistory=[], lastBeatTime=0, beatIntervals=[];

    // === Waveform vars ===
    const canvas=document.getElementById('wave');
    const ctx=canvas.getContext('2d');
    let width, height, dpr=window.devicePixelRatio||1;
    let waveformData=[]; 
    let currentPattern=[], patternIndex=0, fade=0;

    function resize(){
      width=canvas.clientWidth;
      height=canvas.clientHeight;
      canvas.width=width*dpr;
      canvas.height=height*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);

      const targetLength = width; 
      if (waveformData.length < targetLength) {
        const padding = new Array(targetLength - waveformData.length).fill(0);
        waveformData = padding.concat(waveformData);
      } else if (waveformData.length > targetLength) {
        waveformData = waveformData.slice(waveformData.length - targetLength);
      }
    }
    window.addEventListener('resize',resize);
    resize();

    function drawWave(){
      ctx.fillStyle="#ffffff";
      ctx.fillRect(0,0,width,height);

      const minorGrid = 10;
      const majorGrid = 50;

      ctx.strokeStyle = "#ffe4e6"; 
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let x = 0; x <= width; x += minorGrid) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
      for (let y = 0; y <= height; y += minorGrid) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
      ctx.stroke();

      ctx.strokeStyle = "#fecdd3"; 
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      for (let x = 0; x <= width; x += majorGrid) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
      for (let y = 0; y <= height; y += majorGrid) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
      ctx.stroke();

      ctx.strokeStyle = "#e2e8f0";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, height / 2);
      ctx.lineTo(width, height / 2);
      ctx.stroke();

      ctx.strokeStyle="#2563eb"; 
      ctx.lineWidth=2.5; 
      ctx.beginPath();
      for(let i=0;i<waveformData.length;i++){
        const y=(0.5-waveformData[i]/2)*height;
        const x=(i/waveformData.length)*width;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    function updateWave(){
      if(!paused){
        const sample = getNextSample();
        waveformData.push(sample);
        waveformData.shift();
        drawWave();
      }
      requestAnimationFrame(updateWave);
    }

    function getNextSample(){
      if(currentPattern.length>0){
        const val=currentPattern[patternIndex++];
        if(patternIndex>=currentPattern.length){currentPattern=[];patternIndex=0;}
        return val*fade;
      }
      fade=Math.max(0,fade-0.01);
      return (Math.random()*0.02 - 0.01);
    }

    function generateHeartBeat(bpm) {
      const pattern = [];
      const cycleDuration = (60000 / bpm) / 1000 * 60; 
      const total = Math.floor(cycleDuration);
      
      const intensity = 0.8 + (Math.random() * 0.4); 
      
      for (let i = 0; i < total; i++) {
        const x = i / total;
        const jitter = (Math.random() * 0.01);
        const lub = intensity * Math.exp(-Math.pow((x - (0.15 + jitter)) / 0.05, 2)) * Math.sin(2 * Math.PI * 15 * x);
        const dub = (intensity * 0.6) * Math.exp(-Math.pow((x - (0.45 + jitter)) / 0.03, 2)) * Math.sin(2 * Math.PI * 25 * x);
        const drift = Math.sin(x * Math.PI) * 0.05;
        const noise = (Math.random() * 0.03 - 0.015);
        pattern.push((lub + dub + noise + drift) * 0.6);
      }
      return pattern;
    }

    let nextPlayTime=0;
    function playLubDub(){
      const now=audioCtx.currentTime;
      const startAt=Math.max(now,nextPlayTime);
      nextPlayTime=startAt+0.7; 
      const lubOsc=audioCtx.createOscillator();
      const lubGain=audioCtx.createGain();
      lubOsc.frequency.value=60;
      lubOsc.type='sine';
      lubOsc.connect(lubGain);lubGain.connect(audioCtx.destination);
      lubGain.gain.setValueAtTime(0.4,startAt);
      lubGain.gain.exponentialRampToValueAtTime(0.001,startAt+0.15);
      lubOsc.start(startAt);lubOsc.stop(startAt+0.18);

      const dubOsc=audioCtx.createOscillator();
      const dubGain=audioCtx.createGain();
      dubOsc.frequency.value=90;
      dubOsc.type='sine';
      dubOsc.connect(dubGain);dubGain.connect(audioCtx.destination);
      dubGain.gain.setValueAtTime(0.3,startAt+0.32);
      dubGain.gain.exponentialRampToValueAtTime(0.001,startAt+0.42);
      dubOsc.start(startAt+0.32);dubOsc.stop(startAt+0.44);
    }

    function connectMQTT(){
      if(connected) return;
      document.getElementById('status').textContent="Connecting...";
      client=mqtt.connect(WSS_URL,{username:MQTT_USER,password:MQTT_PASS,protocolVersion:4,clean:true});
      client.on('connect',()=>{
        connected=true;
        document.getElementById('status').textContent="Connected ‚úÖ";
        client.subscribe(TOPIC);
      });
      client.on('message', (topic, msg) => {
        if (msg.toString() === "BEAT" && !paused) {
          const now = Date.now();
          if (lastBeatTime > 0) {
            let interval = now - lastBeatTime;
            beatIntervals.push(interval);
            if (beatIntervals.length > 5) beatIntervals.shift(); 
            let avgInterval = beatIntervals.reduce((a, b) => a + b) / beatIntervals.length;
            let bpm = Math.round(60000 / avgInterval);

            currentPattern = generateHeartBeat(bpm);
            
            if (bpm > 40 && bpm < 180) {
              document.getElementById('bpm').textContent = bpm + " BPM";
              // STORE BOTH TIME AND BPM
              const timeString = new Date().toLocaleTimeString();
              bpmHistory.push({ time: timeString, bpm: bpm });
            }
          }
          
          patternIndex = 0; 
          fade = 1;
          playLubDub();
          lastBeatTime = now;
        }
      });
      client.on('error',()=>document.getElementById('status').textContent="Error ‚ùå");
    }

    document.getElementById('startBtn').onclick=()=>{
      audioCtx.resume();
      paused=false;
      
      bpmHistory = []; 
      beatIntervals = []; 
      lastBeatTime = 0; 
      document.getElementById('bpm').textContent = "-- BPM";

      connectMQTT();
      document.getElementById('startBtn').disabled=true;
      document.getElementById('stopBtn').disabled=false;
      document.getElementById('reportBtn').style.display='none';
    };

    document.getElementById('stopBtn').onclick=()=>{
      paused=true;
      document.getElementById('status').textContent="Stopped";
      document.getElementById('startBtn').disabled=false;
      document.getElementById('stopBtn').disabled=true;
      document.getElementById('reportBtn').style.display='inline-block';
    };

    // Updated Report Generator
    document.getElementById('reportBtn').onclick=()=>{
      const snapshot=canvas.toDataURL('image/png');
      
      // Calculate average by extracting the bpm value from the objects
      const avg = bpmHistory.length ? Math.round(bpmHistory.reduce((sum, entry) => sum + entry.bpm, 0) / bpmHistory.length) : "--";
      
      // Build HTML table rows dynamically
      let tableRows = '';
      if(bpmHistory.length > 0) {
        bpmHistory.forEach(entry => {
          tableRows += `<tr><td>${entry.time}<\/td><td><strong>${entry.bpm}<\/strong><\/td><\/tr>`;
        });
      } else {
        tableRows = `<tr><td colspan="2">No valid BPM data captured.<\/td><\/tr>`;
      }

      const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Stethoscope Report<\/title>
      <style>
        body { font-family: sans-serif; background: #f8fafc; color: #0f172a; text-align: center; padding: 20px; }
        h1 { color: #1e3a8a; }
        img { max-width: 100%; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
        .table-container { max-width: 400px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; color: #475569; }
        td:nth-child(2) { color: #ef4444; text-align: right; }
      <\/style><\/head><body>
      <h1>Smart Stethoscope Report<\/h1>
      <p><b>Date:<\/b> ${new Date().toLocaleString()}<\/p>
      <p><b>Average BPM:<\/b> ${avg}<\/p>
      <img src="${snapshot}" alt="Waveform Snapshot">
      
      <div class="table-container">
        <h3>Recorded BPMs<\/h3>
        <table>
          <thead>
            <tr>
              <th>Time Captured<\/th>
              <th style="text-align:right;">Heart Rate (BPM)<\/th>
            <\/tr>
          <\/thead>
          <tbody>
            ${tableRows}
          <\/tbody>
        <\/table>
      <\/div>
      <\/body><\/html>`;
      
      const blob=new Blob([html],{type:'text/html'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='Stethoscope_Report.html';
      a.click();
    };

    updateWave();
  </script>
</body>
</html>