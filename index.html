<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Audio Stethoscope</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1e293b; max-width: 900px; margin: auto; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        canvas { width: 100% !important; height: 300px !important; background: #000; border-radius: 10px; margin: 20px 0; }
        .btns { display: flex; justify-content: center; gap: 15px; }
        button { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        #connectBtn { background: #3b82f6; color: white; }
        #connectBtn:hover { background: #2563eb; }
        #recBtn { background: #ef4444; color: white; display: none; }
        #status { color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Smart Stethoscope Pro</h1>
        <div id="status">System Offline</div>
        
        <canvas id="audioChart"></canvas>

        <div class="btns">
            <button id="connectBtn" onclick="initBluetooth()">üîó PAIR STETHOSCOPE</button>
            <button id="recBtn" onclick="toggleRecording()">‚è∫ RECORD SESSION</button>
        </div>
    </div>

    <script>
        let bluetoothDevice, characteristic;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 8000 });
        let nextStartTime = 0;
        let dataBuffer = new Array(200).fill(1920);

        // Chart Config
        const ctx = document.getElementById('audioChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: new Array(200).fill(''),
                datasets: [{
                    label: 'Live Heart Audio Wave',
                    data: dataBuffer,
                    borderColor: '#10b981',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: { scales: { y: { min: 1000, max: 3000 }, x: { display: false } }, animation: false }
        });

        async function initBluetooth() {
            try {
                // Connect to BLE
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Smart_Stethoscope' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });

                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                characteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');

                await audioCtx.resume(); // Browser requires interaction to start audio
                await characteristic.startNotifications();

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    // Read 16-bit Unsigned Little Endian
                    let rawVal = event.target.value.getUint16(0, true);
                    
                    // 1. Update Visualization
                    dataBuffer.push(rawVal);
                    dataBuffer.shift();
                    chart.update('none');

                    // 2. Play Audio
                    processAudio(rawVal);
                });

                document.getElementById('status').innerText = "LIVE STREAM ACTIVE";
                document.getElementById('connectBtn').style.display = "none";
                document.getElementById('recBtn').style.display = "block";
            } catch (error) { alert("Setup Failed: " + error); }
        }

        function processAudio(analogValue) {
            // Normalize: (val - baseline) / scale
            let normalized = (analogValue - 1920) / 1024; 
            
            let buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
            buffer.getChannelData(0)[0] = normalized;

            let source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            
            let startTime = Math.max(audioCtx.currentTime, nextStartTime);
            source.start(startTime);
            nextStartTime = startTime + (1 / audioCtx.sampleRate);
        }

        function toggleRecording() {
            // Placeholder for the MediaRecorder logic
            alert("Recording session. Data will be saved as a high-quality WAV.");
        }
    </script>
</body>
</html>